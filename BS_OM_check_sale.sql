USE [ANALIZY_PJ_PK]
GO
/****** Object:  StoredProcedure [Raporty].[BS_OM_check_sale]    Script Date: 16.11.2021 15:05:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--CREATE TABLE BS_TABELA_INDEKS (Item NVARCHAR(15))
--ALTER TABLE BS_TABELA_INDEKS ALTER COLUMN Item NVARCHAR(15) COLLATE Polish_CI_AS
--SELECT * FROM BS_TABELA_INDEKS
--INSERT INTO BS_TABELA_INDEKS (Item) VALUES


--('27713-02-32'),
--('27713-02-N2'),
--('46739-01-N2'),
--('66267-05-02'),
--('66267-27-00'),
--('67790-01-06'),
--('67790-02-02'),
--('67798-01-02'),
--('67798-02-19'),
--('67803-01-33'),
--('67978-02-02'),
--('67978-02-35'),
--('69108-02-02'),
--('69108-02-06'),
--('69142-01-00')


--('69493-L0-00'),
--('69628-01-00')

--('63228-01-01'),
--('63228-01-04'),
--('54909-01-00'),
--('54901-01-00'),
--('63126-01-00'),
--('64720-01-00'),
--('64720-03-00'),
--('64717-01-00'),
--('64359-04-00'),
--('64358-01-02'),
--('65795-01-00'),
--('57203-29-00'),
--('57214-02-35'),
--('57214-32-22'),
--('57214-02-19'),
--('57214-02-03'),
--('63311-24-00'),
--('55200-01-00'),
--('63150-27-00'),
--('64227-01-19'),
--('64227-16-00'),
--('64718-01-00'),
--('59672-03-00'),
--('59672-02-02'),
--('59672-02-19'),
--('64112-01-02'),
--('55422-16-00'),
--('64553-01-26'),
--('64553-01-00'),
--('63261-01-26'),
--('64177-16-00'),
--('64177-16-26'),
--('63538-05-00'),
--('64356-01-02'),
--('64541-01-00'),
--('63815-01-26'),
--('64361-01-00'),
--('63310-01-00'),
--('57316-01-00'),
--('63203-01-00'),
--('54866-01-00'),
--('54862-01-00'),
--('64564-01-00'),
--('63950-01-00'),
--('27761-16-A2'),
--('27761-25-N9'),
--('57725-03-00'),
--('57594-03-00'),
--('64620-04-00'),
--('64618-04-00'),
--('63828-01-00'),
--('63127-01-00'),
--('65058-04-00'),
--('63566-01-00'),
--('64833-01-00'),
--('64833-01-26'),
--('63290-04-00'),
--('63202-03-00'),
--('63519-01-00'),
--('63519-01-26'),
--('57597-01-00'),
--('57597-01-02'),
--('63061-02-00'),
--('63061-02-02'),
--('64127-02-TP'),
--('63948-02-19'),
--('63948-02-32'),
--('63207-02-02'),
--('63207-02-19'),
--('64156-02-02'),
--('63945-02-26'),
--('66348-01-00'),
--('66347-01-00'),
--('65161-01-00'),
--('64807-04-00'),
--('63166-01-00'),
--('63573-04-00'),
--('63152-01-00'),
--('63681-01-00'),
--('63266-07-00'),
--('64707-02-22'),
--('64740-02-02'),
--('64707-02-19'),
--('64740-04-00'),
--('63313-01-02'),
--('63313-01-00'),
--('63214-01-02'),
--('63214-01-00'),
--('63345-01-02'),
--('63345-01-00'),
--('64173-01-00'),
--('64173-01-02'),
--('63343-01-00'),
--('63192-02-02'),
--('63192-02-35'),
--('64156-02-26'),
--('64156-02-00'),
--('64734-03-00'),
--('64735-01-00'),
--('35444-01-00'),
--('66020-31-00'),
--('66027-23-00'),
--('64302-04-00'),
--('64334-01-00'),
--('55104-01-00'),
--('45262-01-N0'),
--('64337-04-00'),
--('64338-01-00'),
--('64330-04-00'),
--('64739-01-00'),
--('64384-04-00'),
--('64577-04-00'),
--('66019-25-00'),
--('64799-03-00'),
--('63915-01-00'),
--('64699-01-00'),
--('64699-01-02'),
--('55272-01-00'),
--('55272-01-02'),
--('61533-02-22'),
--('61533-02-26'),
--('64303-04-00'),
--('66349-02-00'),
--('66694-02-00'),
--('66696-02-00'),
--('63913-01-00'),
--('64548-01-02'),
--('63256-01-02'),
--('63187-01-02'),
--('63503-01-02'),
--('63528-05-02'),
--('63499-02-26'),
--('63526-01-00'),
--('63526-01-02'),
--('63144-01-02'),
--('63250-01-02'),
--('63250-01-00'),
--('63514-01-02'),
--('63514-01-00'),
--('55133-01-02'),
--('45347-03-00'),
--('63907-01-02'),
--('63907-01-00'),
--('63940-01-02'),
--('63940-01-00'),
--('46749-05-02'),
--('64696-01-00'),
--('63144-01-00'),
--('63243-01-02'),
--('63243-01-00'),
--('55412-24-02'),
--('63212-05-00'),
--('55432-01-19'),
--('55432-01-00'),
--('55129-03-00'),
--('55404-03-00'),
--('64142-05-02'),
--('64142-05-64'),
--('64165-16-00'),
--('55506-A8-00'),
--('63835-01-02'),
--('63835-01-00'),
--('64558-04-00'),
--('64561-01-00'),
--('55432-01-34'),
--('63167-01-02'),
--('63167-01-00'),
--('27554-01-NB'),
--('64841-03-00'),
--('64838-03-00'),
--('63811-05-00'),
--('63253-01-02'),
--('63253-01-00'),
--('56803-01-00'),
--('57386-03-00'),
--('64798-27-00'),
--('64560-03-00'),
--('63198-03-00'),
--('63928-01-00'),
--('64340-03-00'),
--('64572-04-00'),
--('64562-03-00'),
--('63967-27-00'),
--('63972-03-00'),
--('63966-27-00'),
--('57970-A8-00'),
--('63969-24-00'),
--('63965-29-00'),
--('63971-03-00'),
--('55463-A8-00'),
--('27473-27-N6'),
--('15427-27-A2'),
--('21959-29-N6'),
--('31048-27-N0'),
--('57990-36-00'),
--('35115-29-N0'),
--('36596-31-N0'),
--('57593-01-00'),
--('57724-04-00'),
--('27761-16-N6'),
--('21959-29-A2'),
--('27553-01-N2'),
--('27553-03-A2'),
--('27553-03-N0'),
--('27554-01-A2'),
--('27554-01-N0'),
--('27554-01-N9'),
--('27554-01-NG'),
--('28943-01-N0'),
--('28943-01-NB'),
--('29343-01-N7'),
--('31451-29-A2'),
--('31451-29-N0'),
--('31631-02-N2'),
--('31631-02-NB'),
--('31645-01-00'),
--('31645-01-N0'),
--('33502-01-C7'),
--('33502-01-C8'),
--('33502-01-N6'),
--('33502-01-N7'),
--('33547-01-N2'),
--('33547-01-NB'),
--('33692-01-A2'),
--('33849-16-A2'),
--('33849-16-N6'),
--('33849-16-N7'),
--('34532-07-01'),
--('34532-07-N1'),
--('34532-26-09'),
--('34532-26-33'),
--('34532-26-N5'),
--('35115-29-00'),
--('35445-01-N0'),
--('43349-01-00'),
--('45266-S3-00'),
--('45290-07-00'),
--('45347-01-00'),
--('45347-02-02'),
--('55133-03-19'),
--('55402-01-00'),
--('55402-01-02'),
--('55458-03-00'),
--('55478-18-00'),
--('55489-01-00'),
--('55489-01-N0'),
--('55839-01-00'),
--('55839-01-02'),
--('55880-04-00'),
--('57201-29-00'),
--('57201-29-N0'),
--('57203-01-N0'),
--('57203-01-N7'),
--('57203-04-00'),
--('57214-16-00'),
--('57214-16-N0'),
--('57838-01-02'),
--('57964-04-00'),
--('57993-A8-00'),
--('57996-A8-00'),
--('58466-16-50'),
--('58466-16-70'),
--('58693-03-00'),
--('58969-01-00'),
--('61533-27-00'),
--('61533-27-02'),
--('62112-16-N0'),
--('62115-01-00'),
--('62115-01-N0'),
--('62116-16-N0'),
--('62408-01-02'),
--('9616-03-A2'),
--('9616-03-N6'),
--('28094-03-N9'),
--('28273-01-N0'),
--('28943-L0-N0'),
--('29222-04-N0'),
--('32221-01-N7'),
--('32226-32-N0'),
--('32477-01-A2'),
--('32477-01-NB'),
--('32722-01-N2'),
--('33548-01-N9'),
--('33770-01-A2'),
--('33779-01-A2'),
--('36157-08-C7'),
--('36157-08-N7'),
--('36790-01-N6'),
--('36795-01-00'),
--('36796-30-00'),
--('37051-01-N0'),
--('39222-01-N2'),
--('39222-01-N9'),
--('45052-L0-00'),
--('50294-01-02'),
--('50294-01-19'),
--('50379-23-00'),
--('51217-24-00'),
--('51912-08-N0'),
--('51912-08-N6'),
--('55738-01-02'),
--('55835-01-00'),
--('55835-01-02'),
--('56413-01-02'),
--('57211-04-N0'),
--('57835-01-02'),
--('58690-01-02'),
--('60737-27-00'),
--('64350-SZ-00'),
--('64350-SZ-03'),
--('60001-TK-N0'),
--('60001-TK-00'),
--('64229-A8-63'),
--('64616-02-02'),
--('64616-04-00'),
--('64534-01-00'),
--('65027-01-00'),
--('63553-27-00'),
--('63570-01-00'),
--('63312-16-00'),
--('59807-01-00'),
--('54784-04-00'),
--('63305-01-26'),
--('63304-01-00'),
--('48297-S5-00'),
--('53389-TT-50'),
--('48267-14-04'),
--('48267-SZ-11'),
--('59389-01-B6'),
--('65165-27-00'),
--('65162-27-00'),
--('65052-04-00'),
--('65163-01-00'),
--('64804-27-00'),
--('63123-01-B6'),
--('63123-01-00'),
--('67613-02-TP'),
--('67613-02-00'),
--('66745-02-00'),
--('64653-01-B6'),
--('64722-04-00'),
--('64625-03-00'),
--('66269-01-00'),
----('64625-01-B6'),
----('55105-27-00'),
----('64573-01-00'),
----('64729-02-02'),
----('63505-01-00'),
----('66390-01-00'),
----('66393-01-00'),
----('66231-01-00'),
----('66230-01-00'),
----('66363-05-TP'),
----('66367-04-00'),
----('63371-02-32'),
----('66359-27-00'),
----('66401-01-00'),
----('66398-01-00'),
----('66360-01-00'),
----('66399-01-00'),
----('64574-02-00'),
----('64535-02-11'),
----('66361-01-00'),
----('66374-03-00'),
----('66377-03-00'),
----('64792-01-00'),
----('55423-03-00'),
----('55453-03-00'),
----('27553-03-00'),
----('27554-01-00'),
----('69195-02-00'),
----('55135-01-02')






----------------------------------------------------------------------------------------------------------------------------------------------------------------------
--EXEC sp_rename 'Raporty.BS_OM_check_sale',  '[Raporty].[BS_OM_check_sale]'
ALTER PROC [Raporty].[BS_OM_check_sale]
AS
BEGIN

-- sprzeda¿ bez ZALANDO - tylko PL SIEÆ
DECLARE @date1 DATE
DECLARE @date2 DATE
DECLARE @year INT

SET @date1 = '2021-09-01' --data startowa od pocz¹tku sezonu
SET @date2 = GETDATE() -- data dziœ
SET @year = '2021';-- rok;

WITH CTE
AS -- sprzeda¿ ze zwrotami 
	(
	SELECT [Item No_],
		[Date],
		[Store No_],
		[Quantity],
		[Net Amount]
	FROM [dbo].[ReturnsSTLines_BI]
	
	UNION ALL
	
	SELECT [Item No_],
		[Date],
		[Store No_],
		[Quantity],
		[Net Amount]
	FROM [dbo].[SalesSTLines_BI]
	),
CTE1 --tylko dla indeksów z mojej tabeli
AS (
	SELECT [Item No_],
		[Date],
		[Store No_],
		CAST(SUM([Quantity]) AS FLOAT) AS 'Quantity',
		CAST(SUM([Net Amount]) AS FLOAT) AS 'Net Sales'
	FROM CTE main
	WHERE main.[Item No_] IN (
			SELECT [Item]
			FROM [ANALIZY_PJ_PK].[dbo].[BS_TABELA_INDEKS] sub
			WHERE main.[Item No_] = sub.[Item]
				AND ([Date]) >= @date1
				AND YEAR([Date]) = @year
				AND main.[Store No_] NOT LIKE '%ZLD%'
			)
	GROUP BY [Item No_],
		[Date],
		[Store No_]
	),
CTE2
AS (
	SELECT [Item No_],
		SUM([Quantity]) AS 'Sum Quantity Sold',
		SUM([Net Sales]) AS 'SumNet Sales'
	FROM CTE1
	GROUP BY [Item No_]
	),
CTE3
AS (
	-- Kazar BI
	SELECT DISTINCT [No_],
		[Season Code],
		[Item Category Code],
		[Special Group Code]
	FROM [dbo].[Item_BI]
	)
SELECT a.[Item No_],
	b.[Item Category Code] AS 'Cat',
	b.[Season Code] AS 'Season',
	b.[Special Group Code] AS 'Group',
	a.[Sum Quantity Sold] AS 'QSales',
	ROUND(a.[SumNet Sales],0) AS 'Net Sales',
	DENSE_RANK() OVER (ORDER BY a.[Sum Quantity Sold] DESC) 'Rank over QSales',
	DENSE_RANK() OVER (ORDER BY a.[SumNet Sales] DESC) 'Rank over Net Sales',
	e.[zdjecie_1] AS Photo

FROM CTE2 a
JOIN CTE3 b
	ON a.[Item No_] = b.[No_]
	--WHERE b.[Special Group Code] = 'K2'
LEFT JOIN [ANALIZY_PJ_PK].[dbo].[magento_zdjecia] e WITH (NOLOCK)
ON a.[Item No_] = e.[kazar_erp_item]
	END